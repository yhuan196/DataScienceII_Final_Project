---
title: "Data science final guideline"
author: "Yi Huang, Yuchen Zhang, Shun Xie"
date: "2023-04-28"
output: 
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 2
  fontsize: 10pt
  geometry: margin=0.5in
  header-includes:
    -\usepackage{fancyhdr}
    -\usepackage{lipsum}
    -\pagestyle{fancy}
    -\fancyhead[R]{\thepage}
    -\fancypagestyle{plain}{\pagestyle{fancy}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      fig.align = "center",
                      fig.width = 8, 
                      fig.height = 6,
                      out.width = "90%")
```

# Final Project


## Deliverables and deadlines
Due: May 10 by 11:59pm\
Each team is required to submit one report.


## Dataset

Please merge the midterm project datasets from two team members, and keep only the unique observations. If there are three team members, you can decide which two datasets to merge. 


## Background

To gain a better understanding of the factors that predict recovery time from COVID-19 illness, a study was designed to combine three existing cohort studies that have been tracking participants for several years. The study collects recovery information through questionnaires and medical records, and leverages existing data on personal characteristics prior to the pandemic. The ultimate goal is to develop a prediction model for recovery time and identify important risk factors for long recovery time.


## Data

recovery.RData 

The dataset in "recovery.RData" consists of 10000 participants. In your analysis, please draw a random sample of 2000 participants using the following R code:

set.seed([last four digits of your UNI]) 

dat <- dat[sample(1:10000, 2000),]

The resulting dat object will contain a random sample of 2000 participants that you can use for your analysis.


## Here is a description of each variable:

Variable Description

- ID (id) :Participant ID

- Gender (gender): 1 = Male, 0 = Female

- Race/ethnicity (race): 1 = White, 2 = Asian, 3 = Black, 4 = Hispanic

- Smoking (smoking): Smoking status; 0 = Never smoked, 1 = Former smoker, 2 = Current smoker

- Height (height): Height (in centimeters)

- Weight (weight): Weight (in kilograms)

- BMI (bmi): Body Mass Index; BMI = weight (in kilograms) / height (in meters) squared

- Hypertension (hypertension): 0 = No, 1 = Yes

- Diabetes (diabetes): 0 = No, 1 = Yes

- Systolic blood pressure (SBP): Systolic blood pressure (in mm/Hg)

- LDL cholesterol (LDL): LDL (low-density lipoprotein) cholesterol (in mg/dL)

- Vaccination status at the time of infection (vaccine): 0 = Not vaccinated, 1 = Vaccinated

- Severity of COVID-19 infection (severity): 0 = Not severe, 1= Severe

- Study (study): The study (A/B/C) that the participant belongs to

- Time to recovery (tt_recovery_time): Time from COVID-19 infection to recovery in days
 

## Report

Your report should be no more than five pages, excluding figures and tables. The total number of figures and tables should not exceed 8. You can submit an Appendix if you would like to include more details for modeling tuning.

For the primary analysis on time to recovery, you may revise your midterm report and incorporate new findings from the methods introduced in the second half of the semester.

As a secondary analysis, please consider time to recovery as a binary outcome (>30 days vs. <= 30 days) and develop a prediction model for this binary outcome.

 
## Note

Similar to the midterm project report, your report should include the following sections: exploratory analysis and data visualization, model training, results, and conclusions. 


```{r, message=FALSE, warning=FALSE}
library(caret)
library(corrplot)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(ISLR)
library(glmnet)
library(mgcv)
library(nlme)
library(earth)
library(vip)
```

## Introduction
```{r}
#load data
load("data/recovery.RData")

#get data from 2 team members uni
set.seed(3554)
dat1 <- dat[sample(1:10000, 2000),]
set.seed(4437)
dat2 <- dat[sample(1:10000, 2000),]

#combine the data and discard duplicates
dat_temp <- rbind(dat1, dat2)
dat <- dat_temp[!duplicated(dat_temp$id),]

#dat is now the final data and it has the length as following:
length(dat$id)

# save(dat, file = "data/covid_recovery.RData")
```
## Exploratory Data Analysis

```{r}

#continuous
ggplot(data, aes(x = age))+geom_density()+labs(title="Distribution for age")
ggplot(data, aes(x = height))+geom_density()+labs(title="Distribution for height")
ggplot(data, aes(x = weight))+geom_density()+labs(title="Distribution for weight")
ggplot(data, aes(x = bmi))+geom_density()+labs(title="Distribution for bmi")
ggplot(data, aes(x = SBP))+geom_density()+labs(title="Distribution for SBP")
ggplot(data, aes(x = LDL))+geom_density()+labs(title="Distribution for LDL")
ggplot(data, aes(x = recovery_time))+geom_density()+labs(title="Distribution for recovery_time")


#discrete
ggplot(data) + geom_bar(aes(x=gender))+labs(title="Bar plot for different gender")
ggplot(data) + geom_bar(aes(x=race))+labs(title="Bar plot for different race")
ggplot(data) + geom_bar(aes(x=smoking))+labs(title="Bar plot for different smoking")
ggplot(data) + geom_bar(aes(x=hypertension))+labs(title="Bar plot for different hypertension")
ggplot(data) + geom_bar(aes(x=diabetes))+labs(title="Bar plot for different diabetes")
ggplot(data) + geom_bar(aes(x=vaccine))+labs(title="Bar plot for different vaccine")
ggplot(data) + geom_bar(aes(x=severity))+labs(title="Bar plot for different severity")
ggplot(data) + geom_bar(aes(x=study))+labs(title="Bar plot for different study")


num_df <- 
  data %>% 
  dplyr::select(age, height, weight, bmi, SBP, LDL, recovery_time) 


# calulate the correlations
res <- cor(num_df, use="complete.obs")

corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

```

```{r}

ggplot(data, aes(x = age, y = recovery_time))+geom_point()+geom_smooth(method = 'gam', se = TRUE, color = 'red')+labs(title="Recovery time against age")
ggplot(data, aes(x = height, y = recovery_time))+geom_point()+geom_smooth(method = 'gam', se = TRUE, color = 'red')+labs(title="Recovery time against height")
ggplot(data, aes(x = weight, y = recovery_time))+geom_point()+geom_smooth(method = 'gam', se = TRUE, color = 'red')+labs(title="Recovery time against weight")
ggplot(data, aes(x = bmi, y = recovery_time))+geom_point()+geom_smooth(method = 'gam', se = TRUE, color = 'red')+labs(title="Recovery time against bmi")
ggplot(data, aes(x = SBP, y = recovery_time))+geom_point()+geom_smooth(method = 'gam', se = TRUE, color = 'red')+labs(title="Recovery time against SBP")
ggplot(data, aes(x = LDL, y = recovery_time))+geom_point()+geom_smooth(method = 'gam', se = TRUE, color = 'red')+labs(title="Recovery time against LDL")

```



## Model training
```{r}
# data manipulation
data = 
  dat %>% 
  mutate(study = factor(dat$study),
         gender = factor(dat$gender),
         hypertension = factor(dat$hypertension),
         diabetes = factor(dat$diabetes),
         vaccine = factor(dat$vaccine),
         severity = factor(dat$severity)) %>% 
  dplyr::select(-id)
head(data)


#Split data into 70-30, using the third member's uni
set.seed(2337)
indexTrain <- createDataPartition(y = data$recovery_time, p = 0.7, list = FALSE)

# training data
train_data <- data[indexTrain,]
train_x <- data[indexTrain,]
train_y <- data$recovery_time[indexTrain]

# test data
test_data <- data[-indexTrain,]
test_x <- data[-indexTrain,]
test_y <- data$recovery_time[-indexTrain]
```

# Resampling method
```{r}
# repeated 10-fold cv
ctrl <- trainControl(method = "repeatedcv",
                     number = 10,
                     repeats = 10)
```

### primary analysis (Regression)

* **Linear regression**
* **Partial least squares (PLS)**
* **Generalized Additive Model (GAM)**
* **Multivariate Adaptive Regression Splines (MARS)**
* **Elastic net**
* **Boosting**
* **Random forest**

#### Linear regression
```{r}
## fit linear model on train data
linear_model <- train(train_x,
                      train_y,
                      method = "lm", 
                      trControl = ctrl)
summary(linear_model)

# view performance on the test set (RMSE)
lm_test_pred <- predict(linear_model, newdata = test_x) # test dataset
lm_test_rmse <- sqrt(mean((lm_test_pred - test_y)^2))
lm_test_rmse
```

#### PLS
```{r}
pls_model <- train(train_x,
                   train_y,
                   method = "pls",
                   tuneGrid = data.frame(ncomp = 1:16),
                   trControl = ctrl,
                   preProcess = c("center", "scale"))
ggplot(pls_model, highlight = TRUE)
ggsave(file = "image/pls_number_of_component.png", width = 10, height = 7)

# view performance on the test set (RMSE)
pls_test_pred <- predict(pls_model, newdata = test_x) # test dataset
pls_test_rmse <- sqrt(mean((pls_test_pred - test_y)^2))
pls_test_rmse
```


#### Modeling Strategy


* **Penalized logistic regression** 
* **Generalized additive model (GAM)** 
* **Multivariate adaptive regression splines (MARS)** 
* **Linear discriminant analysis (LDA)**
* **Random Forest**
* **Boosting**



#### Optimal Tuning Parameters

#### Resampling Results and Model Selection

### secondary analysis (Classification)

#### Data Manipulation

```{r}
#consider time to recovery as a binary outcome (>30 days vs. <= 30 days) and develop a prediction model for this binary outcome.
data_class = 
  data %>% 
  mutate(recovery_time = ifelse(recovery_time>30, 1, 0))

#display the result 
head(data_class)
```




#### Modeling Strategy


* **Penalized logistic regression** 
* **Generalized additive model (GAM)** 
* **Multivariate adaptive regression splines (MARS)** 
* **Linear discriminant analysis (LDA)**
* **Classification and Regression Tree (CART)**
* **Random Forest**
* **Boosting**
* **Support Vector Machine (SVM with Linear and Radial Kernels)**


#### Optimal Tuning Parameters

#### Resampling Results and Model Selection

## Results

### primary analysis


#### Interpretion   

#### Variable Importance

#### model's training/test performance

### secondary analysis

#### Interpretion   

#### Variable Importance

#### model's training/test performance

## Conclusion

## Appendix

